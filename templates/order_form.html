{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <h3>{{ order and "Chỉnh sửa đơn hàng" or "Tạo đơn hàng mới" }}</h3>

  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
      {% for message in messages %}
        
        {% if message is string %}
            {% set category = 'info' %}
            {% set msg_text = message %}
        {% else %}
            {% set category = message[0] %}
            {% set msg_text = message[1] %}
        {% endif %}

        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg_text }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="order-form">
    <h5>Thông tin cơ bản</h5>
    <div class="mb-3">
      <label class="form-label">Mã vận đơn</label>
      <input name="order_code" class="form-control" value="{{ order.order_code if order else '' }}" required>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">Tên người nhận</label>
        <input name="recipient_name" class="form-control" value="{{ order.recipient_info.name if order else '' }}" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">SĐT người nhận</label>
        <input name="recipient_phone" class="form-control" value="{{ order.recipient_info.phone if order else '' }}" required pattern="^\+?\d{9,15}$">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Địa chỉ người nhận</label>
        <input name="recipient_address" class="form-control" value="{{ order.recipient_info.address if order else '' }}" required>
      </div>
    </div>

    <h5>Thông tin kiện hàng</h5>
    <div class="row">
      <div class="col-md-2 mb-3">
        <label class="form-label">Cân nặng (kg)</label>
        <input type="number" step="0.1" min="0" name="weight" class="form-control" value="{{ order.parcel.weight if order else '' }}">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Kích thước (LxWxH cm)</label>
        <div class="d-flex gap-1">
          <input type="number" name="dim_l" class="form-control" placeholder="L" value="{{ order.parcel.dimensions.l if order else '' }}">
          <input type="number" name="dim_w" class="form-control" placeholder="W" value="{{ order.parcel.dimensions.w if order else '' }}">
          <input type="number" name="dim_h" class="form-control" placeholder="H" value="{{ order.parcel.dimensions.h if order else '' }}">
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Nội dung</label>
        <input type="text" name="contents" class="form-control" value="{{ order.parcel.contents if order else '' }}">
        <div class="form-check mt-1">
          <input type="checkbox" name="is_fragile" class="form-check-input" {% if order and order.parcel.is_fragile %}checked{% endif %}>
          <label class="form-check-label">Hàng dễ vỡ</label>
        </div>
      </div>
    </div>

    <h5>Thông tin tài chính</h5>
    <div class="row">
      <div class="col-md-3 mb-3">
        <label class="form-label">Tiền Thu Hộ (COD)</label>
        <input type="number" name="cod_amount" min="0" class="form-control" value="{{ order.financials.cod_amount if order else 0 }}">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Phí vận chuyển</label>
        <input type="number" name="shipping_fee" min="0" class="form-control" value="{{ order.financials.shipping_fee if order else 0 }}">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Phí bảo hiểm</label>
        <input type="number" name="insurance_fee" min="0" class="form-control" value="{{ order.financials.insurance_fee if order else 0 }}">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Tổng cộng</label>
        <input type="number" name="total_amount" min="0" class="form-control" value="{{ order.financials.total_amount if order else 0 }}" readonly>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Trạng thái đơn</label>
      <select name="current_status" class="form-select">
        {% set statuses = ["PENDING_PICKUP","PICKED_UP","IN_TRANSIT","DELIVERING","DELIVERED","CANCELLED"] %}
        {% for st in statuses %}
          <option value="{{ st }}" {% if order and order.current_status==st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn btn-success">Lưu</button>
    <a href="/orders" class="btn btn-secondary">Hủy</a>
  </form>
</div>

<script>
// Tự động tính tổng: COD + Shipping + Insurance
function updateTotal() {
  const cod = parseFloat(document.querySelector('input[name="cod_amount"]').value) || 0;
  const ship = parseFloat(document.querySelector('input[name="shipping_fee"]').value) || 0;
  const ins = parseFloat(document.querySelector('input[name="insurance_fee"]').value) || 0;
  document.querySelector('input[name="total_amount"]').value = (cod + ship + ins).toFixed(0);
}

// Event listeners
['cod_amount','shipping_fee','insurance_fee'].forEach(name=>{
  document.querySelector(`input[name="${name}"]`).addEventListener('input', updateTotal);
});

// Tính luôn khi load form
document.addEventListener('DOMContentLoaded', updateTotal);
</script>
{% endblock %}
