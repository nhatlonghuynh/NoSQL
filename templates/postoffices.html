{% extends "layout.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Mạng lưới Bưu cục</h3>
  <button class="btn btn-primary" onclick="openModal('create')">
    <i class="bi bi-plus-circle"></i> Thêm Bưu cục mới
  </button>
</div>

{% with messages = get_flashed_messages(with_categories=True) %} {% if messages
%} {% for category, msg in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show">
  {{ msg }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %} {% endif %} {% endwith %}

<div class="row">
  <div class="col-md-4 mb-3">
    <input
      type="text"
      id="search-input"
      class="form-control mb-2"
      placeholder="Tìm tên, mã, đường..."
    />

    <div style="max-height: 600px; overflow-y: auto">
      <ul class="list-group" id="po-list">
        {% for o in offices %}
        <li
          class="list-group-item list-group-item-action p-2"
          data-lat="{{ o.location.coordinates[1] }}"
          data-lng="{{ o.location.coordinates[0] }}"
          onclick="focusMap({{ o.location.coordinates[1] }}, {{ o.location.coordinates[0] }}, this)"
        >
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong class="text-primary">{{ o.name }}</strong>
              <span class="badge bg-secondary">{{ o.office_code }}</span>
              <div class="small text-muted mt-1">
                <i class="bi bi-geo-alt"></i> {{ o.address.street }}, {{
                o.address.district }}
              </div>
              <div class="small text-muted">
                <i class="bi bi-telephone"></i> {{ o.phone_number }}
              </div>
            </div>

            <div class="d-flex flex-column gap-1">
              <button
                class="btn btn-sm btn-outline-warning"
                onclick="event.stopPropagation(); openModal('edit', {{ o | tojson | safe }})"
              >
                Sửa
              </button>
              <form
                action="/postoffices/delete/{{ o._id }}"
                method="POST"
                onsubmit="return confirm('Bạn chắc chắn muốn xóa?');"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-outline-danger w-100"
                  onclick="event.stopPropagation();"
                >
                  Xóa
                </button>
              </form>
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-md-8">
    <div
      id="map"
      style="height: 600px; border-radius: 10px; border: 1px solid #ddd"
    ></div>
  </div>
</div>

<div class="modal fade" id="poModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" id="poForm" action="/postoffices/create">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm Bưu cục</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="oid" id="field_oid" />

          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Mã bưu cục</label>
              <input
                type="text"
                name="office_code"
                id="field_code"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label>Tên bưu cục</label>
              <input
                type="text"
                name="name"
                id="field_name"
                class="form-control"
                required
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Số điện thoại</label>
              <input
                type="text"
                name="phone_number"
                id="field_phone"
                class="form-control"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label>Giờ hoạt động</label>
              <input
                type="text"
                name="operating_hours"
                id="field_hours"
                class="form-control"
                placeholder="VD: 8:00 - 17:30"
              />
            </div>
          </div>

          <h6 class="mt-2">Địa chỉ</h6>
          <div class="row">
            <div class="col-md-6 mb-2">
              <input
                type="text"
                name="street"
                id="field_street"
                class="form-control"
                placeholder="Số nhà, Đường"
              />
            </div>
            <div class="col-md-6 mb-2">
              <input
                type="text"
                name="ward"
                id="field_ward"
                class="form-control"
                placeholder="Phường/Xã"
              />
            </div>
            <div class="col-md-6 mb-2">
              <input
                type="text"
                name="district"
                id="field_district"
                class="form-control"
                placeholder="Quận/Huyện"
              />
            </div>
            <div class="col-md-6 mb-2">
              <input
                type="text"
                name="province"
                id="field_province"
                class="form-control"
                placeholder="Tỉnh/TP"
              />
            </div>
          </div>

          <h6 class="mt-2">Tọa độ (GeoLocation)</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Vĩ độ (Latitude)</label>
              <input
                type="number"
                step="any"
                name="lat"
                id="field_lat"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label>Kinh độ (Longitude)</label>
              <input
                type="number"
                step="any"
                name="lng"
                id="field_lng"
                class="form-control"
                required
              />
            </div>
            <small class="text-muted"
              >Mẹo: Bạn có thể lấy tọa độ từ Google Maps (chuột phải -> chọn
              dòng đầu tiên).</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Đóng
          </button>
          <button type="submit" class="btn btn-primary">Lưu Dữ Liệu</button>
        </div>
      </form>
    </div>
  </div>
</div>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  // --- 1. Map Initialization ---
  const map = L.map("map").setView([10.8231, 106.6297], 10); // Mặc định HCM
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
  }).addTo(map);

  const markers = L.markerClusterGroup();
  const listItems = document.querySelectorAll("#po-list li");

  // Load markers từ danh sách HTML
  listItems.forEach((li) => {
    const lat = parseFloat(li.dataset.lat);
    const lng = parseFloat(li.dataset.lng);
    const name = li.querySelector("strong").innerText;

    if (!isNaN(lat) && !isNaN(lng)) {
      const marker = L.marker([lat, lng]).bindPopup(`<b>${name}</b>`);
      markers.addLayer(marker);
    }
  });

  map.addLayer(markers);
  if (markers.getLayers().length > 0) {
    map.fitBounds(markers.getBounds());
  }

  // --- 2. Focus Map Function ---
  function focusMap(lat, lng, element) {
    if (!isNaN(lat) && !isNaN(lng)) {
      map.setView([lat, lng], 16);
      // Highlight active item logic (optional)
      document
        .querySelectorAll("#po-list li")
        .forEach((l) => l.classList.remove("active"));
      element.classList.add("active");
    }
  }

  // --- 3. Search Filter ---
  document.getElementById("search-input").addEventListener("input", (e) => {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll("#po-list li").forEach((li) => {
      const text = li.innerText.toLowerCase();
      li.style.display = text.includes(query) ? "" : "none";
    });
  });

  // --- 4. Modal Logic (Create & Edit) ---
  const poModal = new bootstrap.Modal(document.getElementById("poModal"));

  function openModal(mode, data = null) {
    const form = document.getElementById("poForm");
    const title = document.getElementById("modalTitle");

    if (mode === "create") {
      title.innerText = "Thêm Bưu Cục Mới";
      form.action = "/postoffices/create";
      form.reset();
      document.getElementById("field_oid").value = "";
    } else {
      title.innerText = "Chỉnh Sửa Bưu Cục";
      form.action = "/postoffices/update";

      // Điền dữ liệu vào form
      document.getElementById("field_oid").value = data._id;
      document.getElementById("field_code").value = data.office_code || "";
      document.getElementById("field_name").value = data.name || "";
      document.getElementById("field_phone").value = data.phone_number || "";
      document.getElementById("field_hours").value = data.operating_hours || "";

      // Address
      if (data.address) {
        document.getElementById("field_street").value =
          data.address.street || "";
        document.getElementById("field_ward").value = data.address.ward || "";
        document.getElementById("field_district").value =
          data.address.district || "";
        document.getElementById("field_province").value =
          data.address.province || "";
      }

      // Coordinates
      if (data.location && data.location.coordinates) {
        document.getElementById("field_lng").value =
          data.location.coordinates[0];
        document.getElementById("field_lat").value =
          data.location.coordinates[1];
      }
    }
    poModal.show();
  }
</script>

<style>
  /* Custom scrollbar cho đẹp */
  #po-list::-webkit-scrollbar {
    width: 6px;
  }
  #po-list::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 4px;
  }
</style>

{% endblock %}
